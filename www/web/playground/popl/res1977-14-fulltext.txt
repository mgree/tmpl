parallel program correctness through refinement thomas w jr program in computer science box f university ri abstract we develop a theory for the correctness of asynchronous parallel programs a program is considered correct if its behavior is in some sense similar to that of an abstract version of the gram we discuss various criteria for this arity we then concentrate on one of them and develop a technique for showing that a parallel program is correct with respect to this criterion introduction the benefits of a topdown approach to the design of programs are well known dijkstra the use of such techniques for the correctness of sequential programs makes correctness proofs sim dijkstra and for example we will develop some for using this approach for proving the cor of asynchronous parallel programs the correctness of parallel programs has been studied in lamport and and our approach some to that of rosen his use of the property and equivalent states is similar to the notions of consistency that we develop but he does not explicitly take advantage of program structure part of approach is also related to that of although his is bottomup while ours is topdown as the first step in the development program we an of a in which performed complex operations in an are assumed to be manner for example see figure la here we have a program called for item i to the end of a queue several processes may attempt to perform this op simultaneously so we present an ideal version be performed in which the operation is assumed to as far as correct ness is concerned it is easy predicate null is true for all reachable states to verify invariant that ie the as the next step in the development of a par program we break up sections of the program that were previously assumed to be into more reasonably pieces that is we use operations that are closer to those that some processor might actually perform this work foundation at princeton was supported through grant hill university by the national science g and by bell lab nj while the author was initially end is the address that private i of a cell such i null end i here cell which cells i represents and next takes on the address of is a field within values that refer la some data the cell to other initially s f i figure p when s o do s s i null end i v s sl lb consider the program of figure lb which we call eq here we have broken up the operation of item i onto the queue tions and have used into three and v operations on the semaphore s to ensure that only one process can execute of time invariant these operations during any the predicate in is no longer invariant one period that was although intuitively least very the two parallel similar programs are at the there are two approaches to the correctness of eq the first is to modify the original predicate so that it is invariant in eq the other is to weaken our criteria for correctness so that we con a to b g tk predicate is not invariant the first few difficulties predicate so approach although has associated with it modifying that it becomes invariant in the a the expanded parallel program may be fairly difficult to do even if an found its relation might not be clear invariant to the since predicate can be original predicate we are using a topdown approach to between abstraction the design of a program the programs at different should be welldefined the levels of let us consider the second approach to the cor of eo it is clear that the predicate is true for all reachable states in which no processes are between the p and v hence eq is actually simulating in that the composite effect of transitions tl through is exactly that of transition t of if we can prove that in some sense the execution of eq is by the execution of then the predicate that is invariant in can be used as a weaker of the correctness of eq what we need then is a formal method of propagating the correctness of a program at one level to the programs at lower levels as we through the various levels of abstraction model and notation our model of a parallel program is similar to that presented in we present the model in a slightly different way as we want to put more on the individual processes a parallel program or system is a tuple o is a possibly infinite set of states v is a finite set of variable names ii is a infinite set of processes and z is a finite set of transition names each state of q is a vec tor the components of which are named not uniquely by elements of v each process of consists of a name m and a partial mapping q into q function pf ii certain components of the state vector have unique names from v and are referred to as shared variables the remainder of the components do not have unique names and are referred to as private variables each private variable can only be mod by a unique pf and hence is associated with some particular process we references to private variables by the process name of the variable name in parentheses after the for example if c is the name of a private variable then the particular variable named c that is accessible by process t is called cm for any shared variable b or private cn the value of the variable in state to as qb or qcm respectively variable q is re associated variable im this variable finite of with each process n is a private called the instruction pointer can only take on values from a place there is a natural way in which we can name the ordered pairs of states that are related by the we define a transition to be a set of ordered pairs of states each related by some pf such that the values of instruction pointers are equal in all states which are first in an order ed pair and are also equal in all states which are second in an ordered pair each such transition is given a name from z we assume a between all transitions and x and hence consider z to represent the set of all transitions each states two states transition if t is related defines a transition by t we a relation and ql then write on the and q are this as ql j q only one of the instruction pointers can differ in value between the two states as the transition relation is a subset of the relation specified by some pf if n is the process name associated with the particular instruction pointer involved then we say that n executed the transition t if need be we modify our notation and explicitly mention it as follows tp ql q if ql and q are related by some transition we write ql qr ie tion on which is the union of all unspecified is the letting e denote the null transition we write q q for and q all states ql ha q for all states qq q qq for and we then write if there exists an ql if we need to program we are referring example such that q a specify to say sj we writer for we will always qo to be the start ql and q such that a valid transition state then we say sequence specify some state written as state if there exist states ql q then we say that x is sequence if ql is the start that x is a valid initial trans such from if there exists a valid that ql q then we ql or just reachable transition say that if ql is sequence x q is reachable the start state qo following we present a graphical interpretation of our model we use a directed graph with one class of nodes written as lines representing transitions and the other class of nodes written as places ie the values of instruction see figure place node transition node v process n s instruction value of the indicated l when p do f pointer place has the figure there is an arc from a place a to transition t and from transition t to place b iff there exist two states ql and q such that ql q and in ql some instruction pointer has the value a while m q it has the value b if there is an arc from one node to another we say that the is an input node of the latter and the latter is an output node of the former in any particular state of a parallel program the individual processes are thought of as at the place nodes representing the values of their respective instruction pointers we often to transition nodes information specifying the rela tion that the transition represents for example for a predicate p and a function f we write when p do f to mean that if there is a process t the input place of the transition and p is true when this is we say that t is enabled for the transition then t may move so as to at the output place of the transition and at the same instant the state is further modified as specified by f p is called the enabling predicate of the transition and f is called the action tion of the transition see figure if the disjunction of the enabling predicates of the output transitions of a place is true then the place is called a place and the output transitions are called non transitions the place is called a place and the output are called transitions we often include in our graphical model trans nodes with no input places representing of processes called tions and include transitions with no output places representing of processes called exit transitions see figure an en transition is always enabled and hence al the introduction of an unbounded of processes into the system exit transitions when executed effectively a process t an transition figure l an exit transition these special transitions are not intended to increase the power of the model they are just a convenient shorthand the creation of processes could just as well be represented by infinite of processes at certain places just their time until they are allowed to proceed and destruction of processes could be in a similar fashion a typical way of showing a parallel program to be correct is to prove that all reachable states satisfy some predicate following we give the following definition definition let a unary predicate if be a parallel program j on q is said to be if q is omitted then we mean a predicate to be invariant can be very difficult if done directly it is most often easier if one wants to prove j invariant to prove a stronger version of j to be inductive as defined below also following definition let a unary predicate if be a parallel k on q is said to be program inductive if q is omitted then we mean an important property that of of a parallel program is following and we formalize this property definition we say that a process n is dead in state q if n has not executed an exit and there exists no state q such that q q and t is enabled in q we write this condition as definition a parallel program is said to be if for all processes it is expansion when developing a parallel program it is con at first to treat certain complex opera tions as when more detail is required the complex operations can be split up into less complex component operations with the execution of these components interleaved with the of operations of other processes we call this expansion for example see figure in figure ar we have two processes with one process performing two additions in one step in figure b we have ex this complex operation and introduced new variables to control the execution of the expanded operation correctness of such will be considered in the next section in this section we formally explore the notion of expansion it x xl y xy y xy so initially figure a o n x n when s do x xl figure b let to refine parallel sion as us consider a parallel program transition t of resulting program we write this si we wish in a new act of if t is understood we call transition and we call the sion process or not important we omit the t t the e of the expansion process which contains t the let pl and p be the input and output places of t respectively of there in the graphical interpretation is a path from pl to p only one node t by expanding we replace this single path with a subgraph called the expansion subgraph of containing new place nodes called expansion expansion replacing places and new transition nodes called transitions il is formed from xi by t with the expansion transitions called the input place of the expansion subgraph and p is called the output place of the expansion subgraph referring sion process prototype of subgraph that to figure process is the transition t of figure a is the expansion it is replaced is shown in figure b the by the we will find it to relate the tion names of the expanded system to those of the system we define a homomorphism from the transition names of the expanded system to those of the system for the mapping is just the identity mapping for expansion transitions we will map all but one into the empty string and the remaining transition will map into the prototype of the expansion the choice of which one to map into the prototype is somewhat arbitrary we choose the last transition of an expansion mainly because in this way only complete expansion sequences will map into the prototype more formally mapping onto we define xi where the homomorphism il s if s is not an expansion tion t if tn is an expansion transition the output place of which put place of the expansion is the subgraph and t is the prototype of the sion e for all other expansion tions where e is the empty string this mapping is illustrated in figure expansion graph t illustration s v of the mapping figure i s p il we augment the state set of si by introducing new state set and vectors of values denote where let the pointer variables in the these variables take on some qi denote the state set of si set of we define a partial function il onto where is the state q in qi such that the values of each of the variables in q are the same as those in q is not defined when the expansion instruction pointer has the value of an expansion replacing place we to the transition the expansion transition information nodes specifying state and action relations functions ie enabling we always use q to denote the start state of sys although this is somewhat ambiguous system of which q is the start state should clear from context the be a other processes are also possibly modified by the addition of new variables and the correspond ing are extended over the larger domain we restrict the of other processes so that if n is not the expansion process then we call this restriction the expansion subgraph defines a set of paths from pl to pr which we wish to treat definition the set of expansion sequences t of is the set of all transition sequences from paths from the input place to the output place of the expansion subgraph of that can appear as a subsequence of a valid transition sequence we want to ensure that in some sense expansion sequences the operation performed by the prototype transition we make certain that this the case when transitions are not interleaved with expansion transitions is definition a set of to be accurate if for from t and all states expansion sequences all sequences l ql and q from t is said tn ql i q t where t definition expansion effects of other is the prototype only concerns transitions of interleaved processes transition note that the composite behavior there is no mention of execution with transitions this of the we should contrast with accurate is a restriction on non expansion transitions while accuracy is a similar ly motivated restriction on expansion transitions as accuracy seems to be the more difficult to we this difficulty in the remainder of our work by explicitly requiring an expansion to be accurate while we implicitly assume it to be what we have described concerns only the refine ment of a single transition which we shall refer to as a single expansion we are usually concerned with a sequence of ie ss s tion as we abbreviate our and call such a sequence of a or sim expansion when referring to a our use of the terms expansion process prototype transition etc should be interpreted as referring to the last expansion ie of the we have now developed our idea of an expansion and presented a notation the remainder of the paper mainly concerns what happens when the tion of transitions is interleaved with that of expansion transitions consistency suppose that a system so is correct and sys tem si is the result of expanding so we want to develop criteria on the basis of which we can de whether the correctness of si can be inferred from the correctness of so the criteria which we discuss are based on the notion of si being able to simulate so there are two parameters involved in this very roughly the first parameter concerns what we want to be preserved by the expansion we can use the strict requirement that state reachability be preserved ie that what is true in so always be true in si weaker requirement assuming we can also use the that so cor because a predicate w is inductive that only w need be preserved the second parameter concerns how closely si should follow so again we have two choices the first is the strict requirement that si can only from so when si is executing expansion transitions the second is the weaker requirement that si be allowed to from the path of so as long as it can always get back onto the path of s o we first mention three intuitive ideas which we often to be incorporated as constraints in our correctness criteria the first and third con is not we always require the second essential to the proofs of later because theorems it we present as an optional requirement these ideas are similar in spirit to those of in his definition of simulate our first constraint is that we want both the and expanded systems to be deadlock free if it is desired to have a process this can be accomplished by the use of an exit transition the second constraint which we often place on a correct expansion is what we call our bounded ness constraints we want to bound the amount of time a process executing the expansion transitions as opposed to just a pro to a finite amount of time executing these transitions the essence of the situation that we wish to avoid is expressed in figure if initially ti ta when ik v tb when ik do i il figure process is the expansion process and ta is an expansion transition then ta will always be able to be executed after a finite period of waiting but this waiting period will increase without bound after each successive execution of t in a real system such a situation would result in a of performance hence we usually to ensure a bounded period of waiting similarly if process is regarded as the process and tb an expansion transition after each successive execution of an expansion sequence containing the expansion sequence grow longer without bound hence we usually want to bound the length of expansion sequences will the third in some sense thing that the constraint is the requirement the expanded system can do system can do that ex ple consider the wellknown read o write figure a n bad solution to figure b problem problem et al in figure a we have an solution to it in figure b we have expanded the solution but the expansion requires that the readers and writers alternate this we do not wish to consider correct as the expanded system should have at least as many de of freedom as the system the following definitions ing the states of the various are useful systems in definition we let q represent if each of the n i is defined definition a state q of si is said to be able in sj for defined ij if jl is is an important concept and should be a state of si is ins if the instruction pointers of all processes the values of places that exist in sj in such states we can make direct comparisons of the two systems our correctness criteria will be based on reaching these states and showing that certain properties of the states of sj also hold for the states of si which are con our in s first correctness criterion is fairly strict and useful mainly in systems with trivial interaction among processes referring back to the parameters strict values of simulation we are using that is if their then si should always be capable of reaching a state in so and that all reachable states of si that are in so should be such that their under q are reachable in s this correctness figure criterion represent is in states of and represent states that are in so the lines transition and the bracket means that between states q and the system enters no state that is is then in so the interpretation that if si reaches a state of the diagram q that is not in so then the next state is in s will o be reachable an example of an expansion that is under this criterion is in figure reached that in s correct the ex system is effectively exactly as the system o ql in s o consistency figure initially n x y yx x y yx parallel program figure a y when s ­ do s ti when s ­ do s s a consistent figure expansion b in the following and xi denote the tive sets of transition names of so the system and si the expanded system n is un to be a natural number denotes the reachable set is defined to be q definition free and an expansion consistent if si is are deadlock nq nd i q f if we replace expansion satisfying the consistent with x criterion is then an said to be in an expansion we are not ed so much with preservation of reachability as with the preservation of some weaker predicate w so we weaken the first parameter of simulation that is we modify the consistency definition so that it only need be that w is true of reachable states that are in s o definition free and an expansion if si is are deadlock n i qo nq if we replace expansion with xe z then an criterion i said to be from able le any reachable in so the in so will is in figure here of si that is not next state reached that be such that w is true is an example of an expansion that is figure initially it tl tz j j parallel figure ha tr r j j program t tl lk j jl t j j it t j j a j is a multiple of consistent figure expansion but not consistent is shown in figure here w is the predicate j is a multiple of the ex is clearly but it is not since in the system tl and t will always have consecutive values but in the system this is not necessarily so consistency and both require a certain of an expansion that is the expanded system is only allowed to behave sig differently than the system when it is executing an expansion sequence this structure makes proofs of consistency and w consistency relatively easy as we shall see in the next section we may still want to con some to be correct even if they do not display this structure so we weaken the second parameter and strength en the first parameter of simulation that is we weaken our first correctness criterion in another way so that we do not require all reachable states of si that are in s to be reachable in so what we require is that there always be reach able a state from which direct simulation of so is possible definition an expansion is if sl are dead lockfree and there exists an integer n such that for all reachable states q of there is a valid transition sequence and a state q such that is reachable in s u if v q q then there is a state qb si such s qa and there is a transition sequence and a state q such that qt i b if we replace zn with z then an satisfying the criterion to be in is in figure here from any state of si there is reachable a state that is in s and reachable o in o in figure we have an example of a system that is nor consistent in all but neither states reachable in the system i is a power of two in the expanded system there certainly are reachable states in which i is not a power of two however from any such state there is reachable a state in which i is a power of two from this state direct simulation of the system is possible ql t q reachable figure in so initially il t i i parallel figure a program tr ki il when i is a y power of it i i k kl when i is not a power of a figure expansion b in certain cases when w is inductive in so we can combine the previous two correctness ie we weaken both parameters of tion the combined criterion is that from any reachable state of there is reachable a state which is in so and in which the pre w is true this would mean then that from this state direct simulation of so is possible and hence every time si enters a state in so w would be true unfortunately is not always the case although so and si may both be it is possible that a state q of si that is in s may be such that q initially it when ko do ij il if kl gen i j m if ij parallel figure a program ir if kl en o j n d if ij when ko i il j jl if kl i j an figure expansion b for example see figure in the system the predicate ij is clearly invariant in the expanded system it is possible for i and j to become once this occurs they will only again be equal when an instruction pointer takes on the value of pl but in such a state k will be this is clearly a deadlock situation in the system for the process to proceed in the ex system it must set i and j to val such an expansion one does not want to consider correct because of this problem ability of a state in si which in so w is true so no process is dead we require the is such that it is and in its image in definition an expansion if si is w is inductive in s and there exists n such that is a valid such that for transition sequence states is an integer q of there and a state qf q is in so processes n is q invariant in s o for all if mq qa then there is a state si such sequence that qb qa and there such that q q b is a transition if we replace with then an expansion satisfying the to be in is in figure this is interpreted as from any state that is reachable in s there is reachable a state that is qo ql o q i and dead in figure n i l if i is not a power of then t else i parallel figure a fr i il np ram i i a is a power of b expansion w is true in s not for th state dead in so and such that an example of an expansion which is consistent but neither nor consistent is given in figure this is basically the same as the example of a expansion but the setting of the variable t whenever i is not a power of two the possibility of direct simulation we have presented formalization of our ideas of how a correct expansion should behave we summarize our criteria in figure where an expansion satisfying an upper criterion implies that it satisfies the lower criteria consistent summary of criteria figure proving consistency in his paper on reduction a technique which in the terminology text of our present an expansion to be of a similar work is consistent motivation a method for we develop for proving to be however we con proving first concentrate on consistency similar to that of developing a method it is often convenient to view the component transitions of an expansion as one transition per forming some desired action and a set of other transitions performing actions that are more of a nature not really the of other processes the former transition we call the representative of the expansion in that with to other processes it all that is important of the expansion transitions the of this idea is that it provides a simple method for proving an expansion to be con in developing this idea we need the fol definition let s be a transition of a process different from the expansion process and tr an ex transition s is said to commute round tr in the expanded system iff for each sequence tr tn from the set of expansion sequences t all states q and q and for each tn if ti precedes tr then and if tr precedes st st then qq transition tr is said the expansion to be a representative of in figure but s does are expansion transition s not here transitions transitions tl t t and t s j j j jl s j j jl example d of commutativity figure t j jl if the execution execution of any sion except tr transition s around tr of s is in no way affected by the of the transitions in the we to make certain that a process cannot get stuck while executing expansion transitions ie that the system can always reach a state which is in the system formalize this constraint below we definition that q an expansion so if for each transition q there exists ay s is said sequence from f such ql q z is in so to be x such that we now combine our definitions in a sufficient condition into one consistency definition if all transitions except the expansion process some expansion transition is accurate and said to be of all processes commute around tr and the expansion then the expansion is if sion then the expansion is an is consistent proof we want to show two things which imply that the expansion is consistent if s is a reachable in so then after transitions it will be in able in s state that some finite a state that is not of is if s is in so ill is reachable in a reachable then the image in so state that is this state under let x be any transition sequence such that qo ql since the transitions the expansion is ox can be into a ce xl so that each expansion pose that ql q ql and all transitions of se a in x are s up is not in so this means that the rightmost transitions of x are a proper prefix of an expansion sequence since the sion is x can be extended forming the transition sequence z it is now true that where o q is x y i g q in so since the sion is accurate it follows that viz which proves the theorem there are idea in the terminology that mutual sions examples of the use of the preceding in particular he shows in and context of our present work p and v primitives as used to im exclusion form consistent we now concentrate on proving an expansion be we first consider the case single expansion later we generalize these allowing to of a re since implies consistency we weaken the idea of into something that implies suppose that when a transition sequence is as in the definition of a transition around tr the new se does not take the system into the same state as the previous sequence but if the desired pre w is still true in this new state then we can still show the system to be we a new set of transitions to account for the differences in states arising from the transition sequences definition for system si let l represent the set of all partial functions mapping qi into qi such that for each and each qi if qq is defined then and the value of each instruction pointer in q is the same as the corresponding instruction pointer in lq we call each member of l a residual note although not transitions in the sense that they are not part of the parallel program we will use residuals as if they were part of the program in order to avoid confusion if two states of si are related by a transition sequence that contains residuals we will write and say that we extend p empty x is a transition sequence to map residuals into the definition if there sequence x such that exists a transition we say that ql is if a transition sequence of is such that whenever an expansion sequence is executed the ex of the expansion sequence is not by the execution of any other transitions then this transition sequence is effectively a transition sequence of si with the prototype transition replacing the expansion sequences definition a transition sequence s il is said to be in si if it case that each occurrence of an expansion in x is a substring of x x of is the sequence residuals will be used for proving that w is true for states of an expanded system our general plan for showing an expansion to be w consistent will be as follows given any valid transition sequence of an expanded system leading to a state q that is in the system we will show that there is another transition sequence leading to q which is perform able in the system assuming the sion to be accurate and since w is inductive in the system and residuals do not w it will follow that must be and hence the expansion is we now define a class of transition sequences which are equivalent modulo to transition sequences in s definition a valid transition sequence x of s such that ql q where ql and q are so is said to be if there exists transition sequence y such that and y is in s we our notion of to ensure that in system states in so are always reachable by a finite number of transitions in a definition an expansion si is said to be to so if for each transition sequence x such that qo q there exists a y from such that ql q and q is in s if an expansion is then any valid transition sequence can be extended so that it takes the system into a state that is in the system we formalize this notion as follows definition a transition extend x is y so that let si and let x be sequence such that ql q to so to a end to x a transition sequence ql q and q is in so we are preserved now able to weaken our notion of inter so that only the predicate w need be in an expansion definition an expansion sol is said to if it is accurate and each valid transition sequence of s starting from a state q such that q is can be so that in so and is true the result is related to our previous definition of a sequence around the prototype we define what we call in which we allow the insertion of residuals to fix things up the result condition is a sufficient for but not definition let s be a transition of a process different from the expansion process and let tr be an expansion transition occurring in all expansion sequences s is said to around tr in s if w is inductive in so and z for each sequence tl tn of expansion sequences t all states from the set ql and q from such that is and for each a if tk precedes then ql t q where tip t is a prefix of an sion sequence ing residuals and k and are b if ql tw precedes t then l st t k t k c ql q here rt is a suffix of sion sequence and l and i are ing residuals an r i ii i it il example of i is a multiple i of commutativity figure for an illustration of the definition of w commutativity see figure here tl t and t are an expansion sequence if we let w be the predicate i is a multiple of then rl around each of the expansion transitions but r does not around any of them s up pose it is thought that rp around consider the transition ji o in the sequence this will result in a state in which i if we now consider the sequence as required by the definition this will result in a state in which i what we need is a residual k such that r results this is impossible in a state in which i but since would then be causing a change from a state in which k is true to a state in which w is false provides condition for us with a sufficient theorem let if all processes other than the expansion around tr for some expansion and the expansion is accurate and the expansion is transitions process transition of tr then proof a straightforward definition of induction based on the we now proceed provides a sufficient to show that condition for lemma if is x qq in so w is then inductive if in so and x then x is composed of transitions that exist residuals and expansion transitions in case since we assume that w is inductive in s and by our restriction on expansion t it follows then that implies in the truth of w is preserved by definition residuals case follows from assumption that the expansion is accurate and argument of case case of the the theorem if expansion able then the expansion is is proof let be such that is true suppose that cr is where since the y can be extended into valid transition sequence x yz such that z and q is in si by the definition of x is and hence they exists an x in so such that ql q by lemma we have that implies since we assume that w is true for the in state the theorem follows let us consider some system say so in which the predicate w is inductive if we expand so by a expansion then we have a expansion resulting in s now suppose that we continue to expand creating systems ss by in order to show that the expansion si is we would like to make use of the knowledge that the transitions of si are either transitions of so or expansion transitions given a state q of s we wish there to be a valid transition sequence x such that q q and q is in so using the o we then show that since w is inductive in so must be true in si in the definition of we were only concerned about single now we are concerned about and need to make certain that residuals are not inter with expansion transitions of any system of the sequence as they are only useful when applied to states that are in so we first our definition of tion sequence let x of i is a s if x is in si ix is in si is in up is in so we our definition to account for of definition a valid transition sequence where i such that ql q where q and q are in so is to be sequence y q up if there such that exists a transition u is from z li and are si y is in so residuals definition an expansion is said to be if it is accurate and each valid transition sequence starting from a state q such that q is in so and is true can be so that the result is in order to make use of the idea of in our new context we need to choose the residuals from a slightly restricted class we will only want to apply residuals to states that are in so because only in these states will we know that w is true so we will use those whose locations in a transition sequence can always be changed so that they only occur when the system is in a proper state let l a residual l is said to be in si if for all states ql and q of qi where ql is in so and is true if q where x is from x then there exists ing residual q aid a y from z such ly cl q a that a residual in si if for all qi where ql and q are is true qq lx l is said to be states ql q and q of in s o and q where x is from z then there exists a ing residual l and a y from z such that i using we extend these restricted our definition of residuals definition let s be a transition of a process different from the expansion process and let tr be an expansion transition occurring in all sion sequences s is said to around tr in si if w is inductive in so and for each sequence tl tn from the set of expansion sequences t all states ql and q from qi such that ql is and for each tm if tk p t r i q then li lj t i q where tj t is a prefix of an sion sequence and l is a residual in b if t precedes tk then gt t k t ts km q where t sion sequence is and i residual a of an is an in provides us with a condition for o and all transitions of processes other than the ex process of si around tr for some expansion transition tr and the expansion si is accurate and to s then the expansion is proof definition a straightforward induction of based on the finally a sufficient we show that condition for is theorem if w is inductive in so and si is an expansion then the expansion is proof consider a state ql of si true let y be any valid transition that ql q since the expansion y can be to sequence x yz such that such that is sequence such is a valid transition where q is in so and we now proceed by induction on i the basis i is theorem for the induction step by definition of x is ow and hence there are exists an x in so of the form such that q q y q qq here l and are residuals and u is from z ql by the r q restriction that il and the assumption that the expansion is accurate we have that y q a i b where qa and qb iq from the tion hypothesis we know that the theorem then follows since we know that and k do not w we have presented a method of the problem of proving the correctness of a system in complicated interaction among the processes simply stated our method is to show that the in of processes can be ignored thereby re a system with much interaction between pro to a simpler system with little interaction between processes in the next section we our ideas with an example example parallel garbage collection in this section we use the theory which we have derived to develop and prove correct a program for parallel garbage collection the program is basic that of dijkstra et al although the cor proof is ours what we is a environment with one process called the mutator performing basic lisp operations ie manipulating a set of cells representing a graph structure and another process called the collector performing garbage collection the two processes will execute in with a minimal amount of interaction in particular there will be no places ie neither process will ever have to wait for the other the variables used by the program include a finite set of cells each cell consists of three parts a color and two pointers which will refer ence other cells the two cells called the left son and the right so referenced are son a subset of these cells is designated to be roots they are always accessible by the two processes another cell is specialized to be the head of the free list the is a list of garbage cells a cell is garbage if it is not on a path from a root it is otherwise the collector process determines which cells are garbage and then places these garbage cells on the the mutator process may take cells off the and make them sons of cells for more details see dijkstra et al m perform basic lisp operation cells p c collect garbage gc o figure initially we consider the program which we the mutator as one transition and the transition will be thought of as some basic lisp operation of figure process is one place performing the collector process is as two transitions representing a marking and a collect ing phase and two places all cells are assumed to be initially white the first transition col all cells black the second trans then places all white ie garbage cells on the and the black cells to white we first will prove be presented sketch them to the be to then we for a w yet to the first step is to expand the marking phase of the collector as is mentioned in et al it is necessary to specify some overhead on the part of the mutator the reason for this is shown in figure from in figure a root points to cell a and the col is examining root to see if it has any sons which it does not as shown in figure b the collector root to see if it has any sons but in the the tor has modified the graph structure cells and now root points to cell of the set of a but root does not the collector that root does not have any sons and assumes that cell a is garbage in order to avoid this problem an intermediate color for a cell mutator at the same instant that pointer to a cell makes the cell to use the term of dijkstra et al we introduce gray the it establishes at least gray a the details in figure of the first expansion here to a cell are shown gray root root collector y cell a figure a root root collector cell a figure b t all gray when do g do il to cells af then do left gray son gray if any right son gray if color black c the expansion transition t subgraph of of to form gc figure q n this replaces a ti l is not gray tc when is gray ft left son gray if any if right any son color black the expansion subgraph figure of with to make means if the cell is white else do nothing a cell at then color least gray it gray it is not difficult to sion is accurate we prove as well verify later that the it is the marking phase is further expanded in figure now we come to the expansion transition we will ignore one one process adding cells to the the other process removes them of the been treated by several authors for example of the mutator detail that of while this is an in problem which has see dijkstra there is one detail associated with the list that we do consider however this is the problem of how to handle a cell during the period from when it is taken off the to when it is made the son of some cell we solve this problem differently from as was done in et al where an elegant solution is pre to both this problem and the problem but is not proven correct we have the mutator mark any cell that is about to be made the son of some other cell this mark cannot be erased by the collector and a marked cell even if the cell is white is not treated as garbage in the collection phase the details of the expansion are shown in figure the final expansion of the collecting shown in figure is straightforward phase let let cell list mark c be c be or a c a either a cell from cell the free m set c is right be c or left son to c gray m c the expansion subgraph of each cell has been given a mark field to mark a cell means to set the field to to it means set the field to o transition c the collection phase is modified to read place all cells that are white and on to figure v marked do color white when is white a not marked ii do place on free list the expansion subgraph of figure we now concentrate on proving garbage collection program to be rewritten in figure with more the parallel correct is detail but each m let c be a cell let c be either a or a cell from the set right or left son c and c gray cell to be t all roots gray do while g do il to if left cells gray then son gray if do any color g right son gray black if any end end p c place color all white all cells cells white on gc with more detail o figure transition is still thought of as being we write to mean that no cell col black has as either a right son or a left son a cell colored white and similarly for gray white we assume that in the initial state all cells are colored white and all cells except the roots are on the free list the following are easily shown to be inductive in i collector black roots are colored p the conjunction of the three predicates we call w implies that when the collector any white cell is garbage however they that all garbage cells are white which is at p do not im we will modify by a series of four sions that are for the resulting system gc we will show that since are there will always the predicates exist a reach able state in which the collector is at p and all and only all garbage cells are white the first expansion is shown in figure the key idea in showing that this expansion is is that if one considers a proper prefix of any expansion sequence the composite effect of the expansion transitions their on the collectors instruction pointer is that of a residual this is easily verified by observing that the only predicate affected is no cell is colored white in an expansion sequence and a cell is colored black only if simultaneously its sons are gray we note that in the above we are only considering the collector process and hence can treat it as a se program allowing us to examine the com effect of expansion transitions it follows that around the expansion m the mutator last occurrence ie transition w of t in any qq and ql tt gc ql gc q mt t q where n is a nonnegative integer is a residual whose effect is that of res to pointer variables and is a residual whose effect is that of n restricted to pointer variables the expansion is clearly accurate and hence by theorems and it is w consistent the second expansion resulting in gc is shown in figure we want to show this expansion to be as w is not inductive in gc we first show the expansion to be able ie if t a ql gc tn q sequence then there exist residuals and such that q the modified sequence ql gc in order to show this we need to determine the effect of moving the mutator transitions to the end of the expansion sequence any particular cell is either by the action of the of m or its components are changed in some way the effect of an occurrence of m is either to change the value of one of a cells pointers or to a cell gray we call the execution of either transition tc or th if a cell is gray by an occurrence of m before it is visited then that cell will eventually be colored black and its sons gray in the modified sequence the same effect can be achieved by having kl the cell gray if the cell is gray by an oc of m after it is visited then this ing will not cause other cells to be by a transition of the expansion sequence hence in the modified sequence the effect can be achieved by having l the cell gray the modification of a pointer by m has two effects on a cell the previous target of the pointer is ie it becomes no longer a son of the changed cell the new target of the pointer is adopted ie it becomes a son of the changed cell the effect of delaying the adoption of a cell is the same as the effect of delaying of a cell which we have by delaying the of a cell we may be causing that cell and its descendants to be when they were not in the original sequence we cannot account for this in i as this would require cells to be colored white which would be difficult to show to be instead we have any pointer that is mod by an of m to null this is as the actions of m are not on the previous value of a pointer it may be that in practice the previous value of a pointer is im for the execution of the mutator but this value is not important in establishing the correct ness of the garbage collection scheme the effects of this early of a cell can then be by appropriate cells as was previously discussed we now consider whether ql and as we have defined them really are residuals that is if w is true for some state is w true in the state which is the image under l or the only action of q is to some set of states gray as the mutators instruction pointer does not reference p this will clearly preserve w l will some set of cells gray and will also set some set of pointers to null again it is clear that neither of these actions will w that the expansion is accurate and is easily hence we have that it is w but we need to show that it is this can be by the arguments which showed that the first expansion was ie a proper prefix of an expansion residual sequence is effectively a we now expand the resulting shown in figure we will show that tions around m in gc as all actually tion transition all transitions except commute around m c the c occurs immediately before m the result is that the cell being by the mutator at m will end up but if c occurs after m the result is that the cell will end up white this can clearly be for by a residual after c that the appropriate cell gray it is trivial to verify that the other tions around m hence we have that each collector transition around m the ex is certainly accurate and hence it is we still need to show it to be we do this by showing that the residual e used in the expansion ie a cell gray is occurs in gc that is we must show that if k in a state not in then we can remove i and replace it with a residual it so that will tie system is in a state occur when in since the transition c and the prototype m of our current expansion exist in will only occur in a state in hence the expansion is ow by theorem and is by theorem the final expansion trivially shown in figure is we have shown that our predicate w is inductive in gc as mentioned previously this only implies that no cells will be as garbage it is possible that the system will never be in a state in which all garbage cells have been collected but whenever gc reaches a state that is in the predicate w will be true from such a state direct simulation of is possible and it is not difficult to prove that for any state of in is true after one execution of the marking transition the system will be in a state in which all and only all garbage cells are colored black it then fol that gc is acknowledgements we thank for several helpful paper we also thank ing the manuscript and miss the figures discussions robert about for m this typ for references pj f and dl concurrent control with readers and writers communications of the acm vol no october dijkstra ew notes on structured in structured programming by dijkstra and hoare academic press dijkstra ew lamport l martin aj cs and garbage collection an ation submitted to cacm on the exercise in cooper also oct tw jr and rm on the of abstract models in modeling implementations princeton university dept of engineering computer science laboratory technical report tr october d on structured programming a reply to in acm communications of the acm vol no november r and u proving struc programs correct level by level proc of international conference on reliable software sigplan notices vol no june rm formal verification of parallel programs communications of the acm vol no july lamport l garbage collection once more with massachusetts computer associates ca august lamport l proving the correctness of processing programs massachusetts computer associates ca august rj limitations primitives with conditional of synchronization branching and global variables proceedings of annual acm symposium on theory of computing april rj reduction a method of proving properties of systems of processes of the acm vol no december s and d verifying properties of parallel programs an axiomatic approach communications of the acm vol no may rosen iz correctness of parallel programs the approach ibm research report rc october 